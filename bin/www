#!/usr/bin/env node

// sudo lsof -i:3012 ## see a specific port such as 3012 ##
// sudo kill PID

// Set timezone to New York for all logging
process.env.TZ = 'America/New_York';

/**
 * Module dependencies.
 */

const config = require("config");
const https = require("https");
const fs = require("fs");
const app = require("../app");

/**
 * Normalize a port into a number, string, or false.
 */

function normalizePort(val) {
  const port = parseInt(val, 10);

  if (Number.isNaN(port)) {
    // named pipe
    return val;
  }

  if (port >= 0) {
    // port number
    return port;
  }

  return false;
}

/**
 * Get port from environment and store in Express.
 */

// ulblwebp11.lib.miamioh.edu = prod
// For local testing, comment out the line below to use local certificates
// process.env.HOSTNAME = 'ulblwebp11.lib.miamioh.edu';
console.log("process.env.HOSTNAME: " + process.env.HOSTNAME);

if (process.env.HOSTNAME === "ulblwebp11.lib.miamioh.edu") {
  global.onServer = true;
} else {
  global.onServer = false;
}
console.log(`On Server? : ${global.onServer}`);

const PORT = normalizePort(process.env.PORT || config.get("app.port") || 3012);

let server = {};

if (global.onServer) {
  server = {
    key: "/etc/pki/tls/certs/ulblwebp11.lib.miamioh.edu-privkey.pem",
    cert: "/etc/pki/tls/certs/ulblwebp11.lib.miamioh.edu-cert.pem",
  };
} else {
  server = {
    key: "/Users/qum/Documents/GitHub/justdevicecount/security/cert.key",
    cert: "/Users/qum/Documents/GitHub/justdevicecount/security/cert.pem",
  };
}

https
  .createServer(
    {
      key: fs.readFileSync(server.key),
      cert: fs.readFileSync(server.cert),
    },
    app
  )
  .listen(PORT, () => {
    console.log(`HTTPS Server running on port ${PORT}`);
    console.log(`Server environment: ${global.onServer ? 'production' : 'development'}`);
    console.log(`Access URLs:`);
    if (global.onServer) {
      console.log(`  Production: https://ulblwebp11.lib.miamioh.edu:${PORT}`);
    } else {
      console.log(`  Local: https://localhost:${PORT}`);
      console.log(`  Network: https://127.0.0.1:${PORT}`);
    }
    console.log(`API Endpoints:`);
    console.log(`  Patron API: https://localhost:${PORT}/patronapi`);
    console.log(`  Recreation API: https://localhost:${PORT}/recapi`);
    console.log(`  Floor Count API: https://localhost:${PORT}/count_by_floor`);
  });
